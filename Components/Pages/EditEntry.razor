@page "/edit-entry/{Id:guid}"
@using MyJournalApp.Models
@using MyJournalApp.Services
@inject JournalService JournalService
@inject NavigationManager Navigation
@inject MarkdownService MarkdownService
@inject IJSRuntime JS

<PageTitle>Edit Entry - My Journal App</PageTitle>

@if (entry == null)
{
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-6">
                <div class="alert alert-warning" role="alert">
                    <strong>‚ö†Ô∏è Entry Not Found</strong><br />
                    The journal entry you're looking for doesn't exist or has been deleted.
                </div>
                <a href="/journal-list" class="btn btn-secondary">‚Üê Back to List</a>
            </div>
        </div>
    </div>
}
else
{
    <div class="container">
        <div class="row">
            <div class="col-12 text-center">
                <h1 class="mb-4">‚úèÔ∏è Edit Journal Entry</h1>
            </div>
        </div>

        <div class="row justify-content-center">
            <div class="col-lg-10 col-xl-9">
                <div class="card">
                    <div class="card-body">
                        <EditForm Model="@entry" OnValidSubmit="@HandleSubmit">
                            <DataAnnotationsValidator />

                            <div class="form-group mb-4">
                                <label for="title" class="form-label">Title <span class="text-danger">*</span></label>
                                <InputText id="title" class="form-control" placeholder="Enter a title for your journal entry" @bind-Value="entry.Title" />
                                <ValidationMessage For="@(() => entry.Title)" />
                            </div>

                            <div class="form-group mb-4">
                                <label for="entryDate" class="form-label">Entry Date <span class="text-danger">*</span></label>
                                <InputDate id="entryDate" class="form-control" @bind-Value="entryDate" />
                                <ValidationMessage For="@(() => entryDate)" />
                                <div class="form-text">Select the date for this journal entry.</div>
                            </div>

                            <div class="form-group mb-4">
                                <label for="category" class="form-label">Category</label>
                                <InputText id="category" class="form-control" list="categoryOptions" placeholder="Add or select a category" @bind-Value="entry.Category" />
                                <datalist id="categoryOptions">
                                    @foreach (var category in availableCategories)
                                    {
                                        <option value="@category"></option>
                                    }
                                </datalist>
                            </div>

                            <div class="form-group mb-4">
                                <label class="form-label">Primary Mood <span class="text-danger">*</span></label>

                                <InputSelect class="form-select" @bind-Value="entry.PrimaryMood" @bind-Value:after="HandlePrimaryMoodChanged">
                                    <option value="">-- Select primary mood --</option>
                                    @foreach (var m in MoodCatalog.PrimaryMoods)
                                    {
                                        <option value="@m">@m</option>
                                    }
                                </InputSelect>

                                <ValidationMessage For="@(() => entry.PrimaryMood)" />
                            </div>

                            <div class="form-group mb-4">
                                <label class="form-label">Secondary Moods (up to 2)</label>
                                <div class="mood-grid">
                                    @foreach (var mood in GetSecondaryMoodOptions())
                                    {
                                        <label class="tag-option">
                                            <input type="checkbox"
                                                   checked="@IsMoodSelected(mood)"
                                                   disabled="@IsSecondaryMoodDisabled(mood)"
                                                   @onchange="(e) => ToggleSecondaryMood(e, mood)" />
                                            <span>@mood</span>
                                        </label>
                                    }
                                </div>
                                <div class="form-text">Pick up to two supporting moods.</div>
                                @if (!string.IsNullOrWhiteSpace(secondaryMoodMessage))
                                {
                                    <div class="validation-message">@secondaryMoodMessage</div>
                                }
                            </div>

                            <div class="form-group mb-4">
                                <label class="form-label">Tags</label>
                                <div class="tag-list">
                                    @foreach (var tag in availableTags)
                                    {
                                        <label class="tag-option">
                                            <input type="checkbox"
                                                   checked="@IsTagSelected(tag)"
                                                   @onchange="(e) => ToggleTag(e, tag)" />
                                            <span>@tag</span>
                                        </label>
                                    }
                                </div>
                                <div class="d-flex gap-2 mt-2">
                                    <InputText class="form-control" placeholder="Add a custom tag" @bind-Value="customTag" />
                                    <button type="button" class="btn btn-outline-primary btn-sm" @onclick="AddCustomTag">Add Tag</button>
                                </div>
                                @if (entry.Tags.Count > 0)
                                {
                                    <div class="tag-list mt-2">
                                        @foreach (var tag in entry.Tags)
                                        {
                                            <span class="tag-chip">
                                                @tag
                                                <button type="button" @onclick="() => RemoveTag(tag)">x</button>
                                            </span>
                                        }
                                    </div>
                                }
                            </div>

                            <div class="form-group mb-4">
                                <label for="entryContentEdit" class="form-label">Content <span class="text-danger">*</span></label>
                                <div class="markdown-toolbar">
                                    <button type="button" class="btn btn-outline-primary btn-sm" @onclick='() => ApplyMarkdown("bold")'>Bold</button>
                                    <button type="button" class="btn btn-outline-primary btn-sm" @onclick='() => ApplyMarkdown("italic")'>Italic</button>
                                    <button type="button" class="btn btn-outline-primary btn-sm" @onclick='() => ApplyMarkdown("heading")'>Heading</button>
                                    <button type="button" class="btn btn-outline-primary btn-sm" @onclick='() => ApplyMarkdown("list")'>List</button>
                                    <button type="button" class="btn btn-outline-primary btn-sm" @onclick='() => ApplyMarkdown("link")'>Link</button>
                                </div>
                                <InputTextArea id="entryContentEdit" class="form-control" rows="12" placeholder="Write your thoughts, experiences, or reflections here..." @bind-Value="entry.Content" />
                                <ValidationMessage For="@(() => entry.Content)" />
                                <div class="form-text">You can write in plain text or Markdown format.</div>
                                <div class="d-flex gap-2 mt-2">
                                    <button type="button" class="btn btn-outline-primary btn-sm" @onclick="TogglePreview">
                                        @(showPreview ? "Hide Preview" : "Show Preview")
                                    </button>
                                </div>
                                @if (showPreview)
                                {
                                    <div class="markdown-preview mt-2">
                                        @((MarkupString)MarkdownService.ToHtml(entry.Content))
                                    </div>
                                }
                            </div>

                            @if (!string.IsNullOrEmpty(errorMessage))
                            {
                                <div class="alert alert-danger" role="alert">
                                    <strong>‚ö†Ô∏è Error:</strong> @errorMessage
                                </div>
                            }

                            <div class="mb-4 p-3" style="background-color: var(--bg-light); border-radius: var(--radius);">
                                <small class="text-muted">
                                    <strong>üìÖ Created:</strong> @entry.CreatedAt.ToString("MMMM dd, yyyy 'at' h:mm tt")<br />
                                    <strong>üîÑ Last Updated:</strong> @entry.UpdatedAt.ToString("MMMM dd, yyyy 'at' h:mm tt")
                                </small>
                            </div>

                            <div class="d-flex gap-2 mt-4">
                                <button type="submit" class="btn btn-primary">üíæ Update Entry</button>
                                <a href="/journal-list" class="btn btn-secondary">Cancel</a>
                            </div>
                        </EditForm>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public Guid Id { get; set; }

    private JournalEntry? entry;
    private DateOnly entryDate;
    private string errorMessage = string.Empty;

    private List<string> availableTags = new();
    private List<string> availableCategories = new();
    private string customTag = string.Empty;
    private string secondaryMoodMessage = string.Empty;
    private bool showPreview;

    protected override async Task OnParametersSetAsync()
    {
        entry = await JournalService.GetEntryAsync(Id);
        if (entry != null)
        {
            entryDate = entry.EntryDate;
        }

        var existingEntries = await JournalService.GetAllEntriesAsync();

        availableTags = TagCatalog.Core
            .Concat(existingEntries.SelectMany(entryItem => entryItem.Tags))
            .Where(tag => !string.IsNullOrWhiteSpace(tag))
            .Distinct(StringComparer.OrdinalIgnoreCase)
            .OrderBy(tag => tag)
            .ToList();

        availableCategories = CategoryCatalog.Default
            .Concat(existingEntries.Select(entryItem => entryItem.Category))
            .Where(category => !string.IsNullOrWhiteSpace(category))
            .Distinct(StringComparer.OrdinalIgnoreCase)
            .OrderBy(category => category)
            .ToList();
    }

    private async Task HandleSubmit()
    {
        try
        {
            errorMessage = string.Empty;
            if (entry != null)
            {
                entry.EntryDate = entryDate;
                await JournalService.UpdateEntryAsync(entry);
                Navigation.NavigateTo("/journal-list");
            }
        }
        catch (InvalidOperationException ex)
        {
            errorMessage = ex.Message;
        }
        catch (Exception)
        {
            errorMessage = "An error occurred while updating the entry. Please try again.";
        }
    }

    private void HandlePrimaryMoodChanged()
    {
        if (entry == null || string.IsNullOrWhiteSpace(entry.PrimaryMood))
        {
            return;
        }

        var allowed = GetSecondaryMoodOptions();
        entry.SecondaryMoods.RemoveAll(mood => !allowed.Contains(mood, StringComparer.OrdinalIgnoreCase));
    }

    private void ToggleSecondaryMood(ChangeEventArgs args, string mood)
    {
        if (entry == null)
        {
            return;
        }

        var isChecked = ParseCheckbox(args);

        if (isChecked)
        {
            if (string.IsNullOrWhiteSpace(entry.PrimaryMood))
            {
                secondaryMoodMessage = "Select a primary mood before adding secondary moods.";
                return;
            }

            if (IsSecondaryMoodDisabled(mood))
            {
                secondaryMoodMessage = "You can select up to two secondary moods.";
                return;
            }

            if (!IsMoodSelected(mood))
            {
                entry.SecondaryMoods.Add(mood);
            }
        }
        else
        {
            entry.SecondaryMoods.RemoveAll(item => string.Equals(item, mood, StringComparison.OrdinalIgnoreCase));
        }

        secondaryMoodMessage = string.Empty;
    }

    private bool IsMoodSelected(string mood)
    {
        return entry != null && entry.SecondaryMoods.Any(item => string.Equals(item, mood, StringComparison.OrdinalIgnoreCase));
    }

    private bool IsSecondaryMoodDisabled(string mood)
    {
        if (entry == null)
        {
            return true;
        }

        if (string.IsNullOrWhiteSpace(entry.PrimaryMood))
        {
            return true;
        }

        if (string.Equals(mood, entry.PrimaryMood, StringComparison.OrdinalIgnoreCase))
        {
            return true;
        }

        return entry.SecondaryMoods.Count >= 2 && !IsMoodSelected(mood);
    }

    private List<string> GetSecondaryMoodOptions()
    {
        if (entry == null)
        {
            return new List<string>();
        }

        return MoodCatalog.GetSecondaryMoods(entry.PrimaryMood)
            .Distinct(StringComparer.OrdinalIgnoreCase)
            .OrderBy(mood => mood)
            .ToList();
    }

    private void ToggleTag(ChangeEventArgs args, string tag)
    {
        if (entry == null)
        {
            return;
        }

        var isChecked = ParseCheckbox(args);
        if (isChecked)
        {
            AddTag(tag);
        }
        else
        {
            RemoveTag(tag);
        }
    }

    private bool IsTagSelected(string tag)
    {
        return entry != null && entry.Tags.Any(item => string.Equals(item, tag, StringComparison.OrdinalIgnoreCase));
    }

    private void AddCustomTag()
    {
        if (entry == null)
        {
            return;
        }

        var tag = customTag.Trim();
        if (string.IsNullOrWhiteSpace(tag))
        {
            return;
        }

        AddTag(tag);
        customTag = string.Empty;
    }

    private void AddTag(string tag)
    {
        if (entry == null)
        {
            return;
        }

        if (!IsTagSelected(tag))
        {
            entry.Tags.Add(tag);
        }

        if (!availableTags.Any(item => string.Equals(item, tag, StringComparison.OrdinalIgnoreCase)))
        {
            availableTags.Add(tag);
            availableTags = availableTags.OrderBy(item => item).ToList();
        }
    }

    private void RemoveTag(string tag)
    {
        entry?.Tags.RemoveAll(item => string.Equals(item, tag, StringComparison.OrdinalIgnoreCase));
    }

    private void TogglePreview()
    {
        showPreview = !showPreview;
    }

    private async Task ApplyMarkdown(string action)
    {
        switch (action)
        {
            case "bold":
                await JS.InvokeVoidAsync("markdownEditor.wrapSelection", "entryContentEdit", "**", "**", "bold text");
                break;
            case "italic":
                await JS.InvokeVoidAsync("markdownEditor.wrapSelection", "entryContentEdit", "*", "*", "italic text");
                break;
            case "heading":
                await JS.InvokeVoidAsync("markdownEditor.prefixLines", "entryContentEdit", "# ");
                break;
            case "list":
                await JS.InvokeVoidAsync("markdownEditor.prefixLines", "entryContentEdit", "- ");
                break;
            case "link":
                await JS.InvokeVoidAsync("markdownEditor.wrapSelection", "entryContentEdit", "[", "](url)", "link text");
                break;
        }
    }

    private static bool ParseCheckbox(ChangeEventArgs args)
    {
        if (args.Value is bool boolValue)
        {
            return boolValue;
        }

        return string.Equals(args.Value?.ToString(), "true", StringComparison.OrdinalIgnoreCase);
    }
}



